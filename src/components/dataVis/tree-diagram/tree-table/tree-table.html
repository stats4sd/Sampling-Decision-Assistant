<!-- aggregation table -->
<div>
  <!-- <div class="section-title">Allocation by Stage</div> -->
  <!-- <div *ngIf="recommendations$ | async; let recommendations"> -->
  <div *ngIf="recommendations">
    <table style="margin-bottom:2em">
      <tr>
        <td class="no-border"></td>
        <td class="no-border"></td>
        <td class="no-border"></td>
        <th colspan="2" style="text-align: center">Strata</th>
      </tr>
      <tr>
        <th>Stage</th>
        <th>Take</th>
        <th>Total</th>
        <th>Reporting</th>
        <th>Non-Reporting</th>
      </tr>
      <tr *ngFor="let stage of samplingStages; index as i; first as first">
        <!-- stage -->
        <td>{{stage.name}} <span *ngIf="!first">per {{samplingStages[i-1].name}}</span></td>
        <!-- take -->
        <td>{{stage['q5.3.3']}}</td>
        <!-- total -->
        <td *ngIf="i<samplingStages.length-1" class="table-input">
          <ion-input type="number" [(ngModel)]="stage.sampleSize" (ionChange)="allocationChange($event,i)"></ion-input>
        </td>
        <td *ngIf="i==samplingStages.length-1" class="table-fixed">{{recommendations.countFinalStage}}</td>
        <!-- Reporting levels -->
        <td>
          <div *ngIf="stage._reportingLevels">
            <div *ngFor="let level of stage._reportingLevels">
              <div *ngIf="level.reportingRequired">
                <div class="strata-name">{{level.name}}</div>
                <div style="display: flex; flex-wrap: wrap">
                  <div class="strata-classification" *ngFor="let name of level.classifications.names">
                    <div>- {{name}}</div>
                    <div class="sample-size">n = {{stage.sampleSize}}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </td>
        <!-- additional strata -->
        <td>
          <div *ngIf="stage._reportingLevels">
            <div *ngFor="let level of stage._reportingLevels">
              <div *ngIf="!level.reportingRequired">
                <div class="strata-name">{{level.name}}</div>
                <ul>
                  <li class="strata-classification" *ngFor="let name of level.classifications.names">{{name}}</li>
                </ul>
              </div>
            </div>
          </div>
        </td>
      <tr>
        <th>
          <div>Reporting Combination Sample Size</div>
        </th>
        <td></td>
        <td [class]="allocationSampleSize>=recommendations.requiredPerAggregation ? 'pass':'fail'">
          <span *ngIf="allocationSampleSize>0">{{allocationSampleSize}}</span>
        </td>
        <td></td>
        <td></td>
      </tr>
      <tr>
        <td>Overall Sample Size</td>
        <td></td>
        <td>
          <span *ngIf="allocationSampleSize>0">{{allocationSampleSize *
            recommendations.disaggregationMeta.levelCombinations.length}}</span>
        </td>
        <td></td>
        <td></td>
      </tr>
    </table>
    <note type="warning" *ngIf="allocationSampleSize && allocationSampleSize < recommendations.requiredPerAggregation">
      The recommended minimum sample size is {{recommendations.requiredPerAggregation}} for each reporting combination
    </note>
  </div>
</div>